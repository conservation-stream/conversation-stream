name: on-push

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  determine:
    uses: ./.github/workflows/determine_changes.template.yml
    secrets: inherit
    with:
      base_sha: ${{ github.event.before }}

  run:
    name: ${{ matrix.name }}
    needs: determine
    if: needs.determine.outputs.count != '0'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.determine.outputs.matrix) }}
    uses: ./.github/workflows/run_ci.template.yml
    secrets: inherit
    with:
      dir: ${{ matrix.dir }}
      name: ${{ matrix.name }}
      environment: production
      build_matrix: ${{ matrix.build_matrix && toJSON(matrix.build_matrix) || '{"include":[{"matrix_key":"default","matrix_values_json":"{}"}]}' }}
